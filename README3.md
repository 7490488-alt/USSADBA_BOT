🏡 Telegram-бот «Усадьба» с ИИ через Yandex LLM
AI-помощник для проекта «Усадьба» — отвечает на вопросы, отправляет документы, помнит историю диалога и работает через Yandex LLM.

🚀 Функционал
✅ Ответы от ИИ через Yandex LLM (yandexgpt-lite)
✅ Хранение истории диалогов (по чатам)
✅ Кэширование ответов для экономии токенов и скорости
✅ Отправка документов по запросу
✅ Защита от спама (ограничение 2 сек на запрос)
✅ Асинхронная архитектура (высокая производительность)
✅ Модульная структура (легко масштабировать)
🧰 Технологии
python-telegram-bot v20+ — для работы с Telegram
Yandex LLM — через совместимый с OpenAI API
pydantic-settings — для загрузки .env
httpx — асинхронные HTTP-запросы
pydantic — валидация и настройки
Структура: main.py → bot/ → services/ → utils/

📦 Установка
1. Клонируй репозиторий
git clone https://github.com/ваш-репозиторий/ussadba_bot.git
cd ussadba_bot
2. Установи зависимости
pip install -r requirements.txt
Создай .env файл
BOT_TOKEN=8293618472:AAE...
YA_API_KEY=AQVNzsBBP...
YA_FOLDER_ID=your-folder-id
🔐 Не публикуй ключи в Git! 

📁 Структура проекта
ussadba_bot/
│
├── main.py                     # 🚀 Точка входа: запускает бота
├── config.py                   # ⚙️ Настройки через Pydantic (токены, пути)
├── requirements.txt            # 📦 Зависимости: pip install -r requirements.txt
├── .env                        # 🔐 Переменные окружения (не коммитить!)
│
├── data/                       # 📁 Данные бота
│   ├── documents/              # 📄 PDF, XLSX, DOCX — документы для отправки
│   ├── history/                # 💬 JSON-файлы с историей диалогов
│   └── logs/                   # 📝 Логи по датам: bot_2025-08-30.log
│
├── bot/                        # 🤖 Логика бота
│   ├── __init__.py             # Пакет Python
│   ├── application.py          # 🧩 Регистрация обработчиков (/start, /docs, чат)
│   └── handlers/               # 📥 Обработчики команд
│       ├── start.py            # 🎉 Приветствие и кнопки
│       ├── docs.py             # 📎 Отправка документов
│       └── chat.py             # 💬 Диалог с ИИ через Yandex LLM
│
├── services/                   # ⚙️ Сервисы
│   ├── llm.py                  # 🧠 Клиент Yandex LLM
│   ├── cache.py                # 💾 Кэширование ответов ИИ
│   └── history.py              # 📜 Загрузка/сохранение истории
│
└── utils/                      # 🛠 Вспомогательные утилиты
    ├── logger.py               # 📢 Настройка логирования
    └── helpers.py              # 🔧 Вспомогательные функции (get_cache_key и др.)
    
    🧪 Запуск бота
Запусти из обычного терминала (не из Jupyter/REPL):
python main.py
💡 Если ошибка event loop is already running, используй чистый cmd или PowerShell. 
🛠 Настройка
1. Промпт
Отредактируй:
prompts/prompt_1.txt
2. Документы
Положи файлы в:
data/documents/
И добавь в DOCUMENTS_MAP в docs.py:
DOCUMENTS_MAP = {
    "презентация": "Презентация.pdf",
    "бизнес-план": "Бизнес-план.pdf",
    # ...
}

🐞 Логирование
Логи пишутся в:
data/logs/bot_2025-08-29.log
Пример:
2025-08-29 13:42:05,051 - utils.logger - INFO - ✅ Промпт загружен
2025-08-29 13:42:07,737 - utils.logger - INFO - 🚀 Бот запущен. Ожидание сообщений...

📦 Дальнейшее развитие
Добавить кнопки и меню
Поддержка больших файлов (через облако)
Аналитика: статистика запросов
Docker-образ
Web интерфейс для менеджеров
📄 Лицензия
MIT
🖥️ Web интерфейс для менеджеров: 🧱 "Базовый Flask-интерфейс"

📄 Полный файл bot/handlers/docs.py с автосканированием, защитой и кнопками
🔧 Что делает этот код:
✅ Автосканирование папки
Сканирует data/documents/ при каждом запросе
Автоматически находит все подходящие файлы
Не требует ручного обновления DOCUMENTS_MAP
🔐 Защита от пути вида ../
Проверяет имена файлов на наличие ..
Блокирует абсолютные пути
Проверяет расширения файлов
Фильтрует подозрительные символы
📄 Кнопки для выбора документов
Автоматически создаёт клавиатуру с документами
Показывает эмодзи по типу файла
Поддерживает поиск по названию
Показывает размер файла
✅ Дополнительные функции
Форматирование размера файла (KB, MB)
HTML-разметка для красивого отображения
Обработка ошибок при отправке
Поддержка кириллицы в названиях
🚀 Как использовать:
Положи документы в data/documents/
Запусти бота
Напиши /docs — получишь меню с кнопками
Нажми на кнопку или введи название документа



Кнопки для документов добавляются в файл:
bot/handlers/docs.py

"Добавь админ-панель"
"Сделай веб-интерфейс"
"Добавь базу данных (SQLite)"
"Интегрируй с CRM"
✅ "Добавь кнопку 'Документы' в стартовое меню"


